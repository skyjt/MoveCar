{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2>我的挪车码</h2>
  <div class="codes-desktop">
  <table>
    <thead><tr><th>名称</th><th>状态</th><th>创建时间</th><th>操作</th><th>链接</th></tr></thead>
    <tbody>
    {% for c in codes %}
      <tr>
        <td>{{ c.display_name or '-' }}</td>
        <td data-code-row="{{ c.id }}">
          {# 渐进增强：默认提供表单回退；有 JS 时改用 AJAX 局部更新 #}
          <form action="/codes/{{ c.id }}/toggle" method="post" class="inline js-toggle-form">
            <label class="switch" title="点击切换启用状态">
              <input class="switch__input" data-code-id="{{ c.id }}" role="switch" aria-checked="{{ 'true' if c.status == 'ACTIVE' else 'false' }}" type="checkbox" name="enabled" {% if c.status == 'ACTIVE' %}checked{% endif %}>
              <span class="switch__track"><span class="switch__thumb"></span></span>
            </label>
            {% if c.status == 'ACTIVE' %}
              <span class="status status--ok status-label"><strong>生效</strong></span>
            {% else %}
              <span class="status status--bad status-label"><strong>失效</strong></span>
            {% endif %}
            <button type="submit" style="display:none">提交</button>
          </form>
        </td>
        <td class="muted">{{ c.created_at|fmt_dt }}</td>
        <td>
          <div class="actions">
            {# 操作中去掉"切换启用"，改由状态开关控制 #}
            <a class="btn" href="/print/{{ c.public_code }}" target="_blank">
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <rect x="7" y="7" width="10" height="10"/>
                <path d="m9 9 2 2 4-4"/>
              </svg>
              打印 / 下载二维码
            </a>
            <a class="btn btn--ghost" href="/codes/{{ c.id }}/notify">
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="m13.73 21a2 2 0 0 1-3.46 0"/>
              </svg>
              通知设置
            </a>
            <form action="/codes/{{ c.id }}/delete" method="post" class="inline" onsubmit="return confirm('确定删除该挪车码？相关留言将一并删除。');"><button class="btn btn--ghost btn--danger" type="submit">
              <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m3 6 3 0"/>
                <path d="m19 6-1 0"/>
                <path d="m8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <path d="m10 11 0 6"/>
                <path d="m14 11 0 6"/>
                <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2L19 6"/>
              </svg>
              删除
            </button></form>
          </div>
        </td>
        <td><code>/c/{{ c.public_code }}</code><span class="muted" style="display:none" data-id="{{ c.id }}" data-public="{{ c.public_code }}"></span></td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="muted">暂无挪车码，去“新建挪车码”创建一个。</td></tr>
    {% endfor %}
    </tbody>
  </table>
  </div>

  {# 移动端分块展示：名称（标题）/ 状态 / 时间 / 操作 / 链接 #}
  <div class="codes-mobile">
    {% for c in codes %}
      <div class="code-card">
        <div class="code-card__title">{{ c.display_name or '-' }}</div>
        <div class="code-card__row" data-code-row="{{ c.id }}">
          <span class="label">状态</span>
          <form action="/codes/{{ c.id }}/toggle" method="post" class="inline js-toggle-form">
            <label class="switch" title="点击切换启用状态">
              <input class="switch__input" data-code-id="{{ c.id }}" role="switch" aria-checked="{{ 'true' if c.status == 'ACTIVE' else 'false' }}" type="checkbox" name="enabled" {% if c.status == 'ACTIVE' %}checked{% endif %}>
              <span class="switch__track"><span class="switch__thumb"></span></span>
            </label>
            {% if c.status == 'ACTIVE' %}
              <span class="status status--ok status-label"><strong>生效</strong></span>
            {% else %}
              <span class="status status--bad status-label"><strong>失效</strong></span>
            {% endif %}
            <button type="submit" style="display:none">提交</button>
          </form>
        </div>
        <div class="code-card__row">
          <span class="label">创建时间</span>
          <span class="muted">{{ c.created_at|fmt_dt }}</span>
        </div>
        <div class="code-card__row actions">
          <a class="btn" href="/print/{{ c.public_code }}" target="_blank">
            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <rect x="7" y="7" width="10" height="10"/>
              <path d="m9 9 2 2 4-4"/>
            </svg>
            打印 / 下载二维码
          </a>
          <a class="btn btn--ghost" href="/codes/{{ c.id }}/notify">
            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
              <path d="m13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            通知设置
          </a>
          <form action="/codes/{{ c.id }}/delete" method="post" class="inline" onsubmit="return confirm('确定删除该挪车码？相关留言将一并删除。');"><button class="btn btn--ghost btn--danger" type="submit">
            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m3 6 3 0"/>
              <path d="m19 6-1 0"/>
              <path d="m8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              <path d="m10 11 0 6"/>
              <path d="m14 11 0 6"/>
              <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2L19 6"/>
            </svg>
            删除
          </button></form>
        </div>
        <div class="code-card__row">
          <span class="label">链接</span>
          <code>/c/{{ c.public_code }}</code>
          <span class="muted" style="display:none" data-id="{{ c.id }}" data-public="{{ c.public_code }}"></span>
        </div>
      </div>
    {% else %}
      <div class="muted">暂无挪车码，去“新建挪车码”创建一个。</div>
    {% endfor %}
  </div>
</div>

<!-- 将系统配置卡片改为与其他卡片同宽，移除窄版样式，统一视觉宽度 -->
<div class="card">
  <h2>系统配置</h2>
  {% if saved %}<p class="muted">已保存配置。</p>{% endif %}
  <form method="post" action="/settings/site" class="stack">
    <div>
      <label>站点标题（浏览器标签与页面标题）</label>
      <input class="input-grow" name="site_title" value="{{ site_title or 'Move Car 挪车码' }}" placeholder="例如：Move Car 挪车码">
    </div>
    <div>
      <label>网站地址（用于二维码与打印页）</label>
      <div class="row">
        <input class="input-grow" id="site-base-input" name="site_base_url" value="{{ site_base_url }}" placeholder="例如：https://example.com">
        <button class="btn btn--subtle" type="button" onclick="autofillBase()">自动获取</button>
      </div>
      <p class="muted form-note">建议填写含协议的完整地址（含端口，如有）：例如 https://your.domain 或 http://192.168.1.10:8000</p>
    </div>
    <div>
      <label>页脚版权（支持 HTML）</label>
      <textarea name="site_footer_html" rows="4" placeholder="支持 HTML，自定义版权或链接">{{ site_footer_html }}</textarea>
      <p class="muted form-note">示例：&lt;span&gt;© 我的站点&lt;/span&gt; &lt;a href="https://github.com/skyjt/MoveCar" target="_blank"&gt;GitHub&lt;/a&gt;</p>
    </div>
    <div class="row">
      <button class="btn" type="submit">保存</button>
    </div>
  </form>
</div>

<script>
function autofillBase(){
  var el = document.getElementById('site-base-input');
  if (!el) return;
  try { el.value = window.location.origin; } catch(e){}
}

// 局部刷新：开关状态使用 AJAX 切换，避免整页刷新
document.addEventListener('DOMContentLoaded', function(){
  var forms = document.querySelectorAll('form.js-toggle-form');
  forms.forEach(function(f){
    // 阻止回车等默认提交（依赖 JS 时走 fetch）
    f.addEventListener('submit', function(ev){ ev.preventDefault(); });
  });
  var inputs = document.querySelectorAll('input.switch__input[data-code-id]');
  inputs.forEach(function(input){
    input.addEventListener('change', async function(ev){
      var el = ev.currentTarget;
      var codeId = el.getAttribute('data-code-id');
      if (!codeId) return;
      // 禁用交互并标记加载态
      el.disabled = true;
      try {
        const res = await fetch('/api/v1/codes/' + codeId + '/toggle', { method: 'POST' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        // 根据返回状态矫正 UI（防“竞态”导致的不同步）
        var active = data.status === 'ACTIVE';
        el.checked = active;
        el.setAttribute('aria-checked', active ? 'true' : 'false');
        // 更新同容器内的状态徽标
        var container = el.closest('[data-code-row]') || document.querySelector('[data-code-row="' + codeId + '"]');
        if (container) {
          var label = container.querySelector('.status-label');
          if (label) {
            label.classList.remove('status--ok','status--bad');
            label.classList.add(active ? 'status--ok' : 'status--bad');
            label.innerHTML = active ? '<strong>生效</strong>' : '<strong>失效</strong>';
          }
        }
      } catch (e) {
        // 请求失败：恢复原状并提示
        el.checked = !el.checked;
        alert('切换失败，请稍后重试');
      } finally {
        el.disabled = false;
      }
    });
  });
});
</script>

<div class="card">
  <h2>最新留言</h2>
  <table>
    <thead><tr><th>ID</th><th>码</th><th>内容</th><th>图片</th><th>时间</th><th>状态</th><th>操作</th></tr></thead>
    <tbody>
    {% for m in messages %}
      <tr>
        <td>{{ m.id }}</td>
        <td>{{ m.code.display_name or m.code.public_code }}</td>
        <td>{{ m.content_text or '-' }}</td>
        <td>{% if m.image_path %}<a href="{{ m.image_path }}" target="_blank">
          <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m1 1 6 6"/>
            <path d="m1 7 6-6"/>
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          查看
        </a>{% else %}-{% endif %}</td>
        <td class="muted">{{ m.created_at|fmt_dt }}</td>
        <td>
          {# 留言处理状态使用中文，并以颜色区分 #}
          {% if m.processed %}
            <span class="status status--ok"><strong>已处理</strong></span>
          {% else %}
            <span class="status status--bad"><strong>未处理</strong></span>
          {% endif %}
        </td>
        <td>
          {% if not m.processed %}
          <form action="/messages/{{ m.id }}/mark" method="post" style="display:inline"><button class="btn btn--subtle" type="submit">
            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4"/>
              <circle cx="12" cy="12" r="10"/>
            </svg>
            标记处理
          </button></form>
          {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="7" class="muted">暂无留言</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
