# Changelog

按时间倒序记录仓库的重要变更。每次执行用户请求并落库后，务必在此追加一条简洁、可检索的记录（含日期、类型、概要与关键文件）。

## 2025-08-29
- style(ui): 统一“系统配置”卡片宽度，移除窄版样式，页面与其他卡片一致更美观
  - Files: app/templates/dashboard.html, app/style.css
- feat: 初始化自部署 MVP（FastAPI + SQLite + Jinja2），新增 Docker 与基础测试
  - Files: app/**, docker-compose.yml, requirements.txt, tests/**
- docs: 重写需求为开源自部署简版；新增设计文档
  - Files: PRD.md, docs/DESIGN.md
- feat: 二维码生成与下载（segno+pypng）；打印页重构为打印友好版（含“挪车请扫码”）
  - Files: app/routes/pages.py, app/templates/print.html, app/style.css, requirements.txt
- feat: UI 焕新与移动端优化（落地页/登录/仪表盘/新建码）
  - Files: app/templates/*.html, app/style.css
- fix: /qr/{code}.png 不再依赖 DB 是否存在该码，避免误 404；PNG 写出依赖补齐
  - Files: app/routes/pages.py, requirements.txt
- feat: 支持删除挪车码（级联清理留言与黑名单），并补充测试
  - Files: app/routes/pages.py, app/templates/dashboard.html, tests/test_delete_code.py
- feat: 通知设置（Bark）— 选择“无”或“Bark”，保存配置并支持“测试通知”；留言成功自动推送
  - Files: app/models.py(CodeNotifyPref), app/services/notify.py, app/routes/pages.py, app/templates/notify.html, app/templates/dashboard.html
- fix: 修复“测试通知”按钮提交到保存接口的问题（使用单表单+formaction）
  - Files: app/templates/notify.html
- fix: 限流键由 (IP, code_id) 改为 (IP, public_code)，避免偶发首条 429
  - Files: app/services/rate_limit.py, app/routes/pages.py
- docs: README 修正本地/开发启动指引与 Bark 使用说明；新增 AGENTS.md
  - Files: README.md, AGENTS.md
- feat: 通知流控：同一码前 3 次通知不受限，之后每 30 秒最多一次（可通过 NOTIFY_MIN_INTERVAL_SEC 配置）
  - Files: app/services/notify.py, app/routes/pages.py
- style: 统一全站样式（字体行高、按钮高度/对齐、表格单元对齐、操作区 actions 分组），优化后台页面整洁与对齐
  - Files: app/style.css, app/templates/dashboard.html
- style: 自动跟随系统浅色/深色主题（prefers-color-scheme），并在独立页添加 color-scheme meta
  - Files: app/style.css, app/templates/base.html, app/templates/landing.html, app/templates/print.html
- fix(style light): 调整浅色模式下“切换启用 / 退出”等次级按钮（btn--subtle）对比度，提升可读性
  - Files: app/style.css
- fix(style light): 通知设置页面输入框在浅色模式下使用白底深字，并将“通知渠道”选择改为紧凑宽度
  - Files: app/style.css, app/templates/notify.html
- docs(code): 为主要模块与函数/类补充中文注释与文档字符串，提升可读性与可维护性
  - Files: app/main.py, app/database.py, app/models.py, app/utils.py, app/services/rate_limit.py, app/services/notify.py, app/routes/pages.py, app/routes/api.py
- feat: 首页（/）新增精美欢迎页（标题 + 进入控制台按钮），适配浅/深色主题
  - Files: app/routes/pages.py, app/templates/home.html, app/style.css
- fix: 未登录时顶栏不再显示“退出”，改为显示“登录”按钮
  - Files: app/templates/base.html
- fix(ui): 统一时间显示格式为“YYYY-MM-DD HH:MM”，移除毫秒，提升可读性
  - Files: app/routes/pages.py (fmt_dt 过滤器), app/templates/dashboard.html
- refactor(config): 简化数据库配置，默认使用 `data/app.db`；上传图片统一存储至 `data/uploads/`，便于 Docker 映射持久化
  - Files: app/utils.py, app/main.py (/media 挂载), app/routes/pages.py（图片路径）, docker-compose.yml, .env.example, README.md
- style(print): 打印页优化排版（标题、二维码、说明、备用链接居中与加粗，复制链接按钮；打印介质隐藏工具栏）提升可读性
  - Files: app/templates/print.html
- feat(config): 仪表盘新增“网站地址”配置，支持手动填写与“自动获取当前地址”一键填充；二维码与打印页优先使用该地址
  - Files: app/models.py(AppSetting), app/routes/pages.py(dashboard 数据/保存接口/_get_base_url/print页), app/templates/dashboard.html
- fix(ui): 系统配置区域采用窄版卡片与伸缩输入框（input-grow），在桌面与移动端观感更协调
  - Files: app/style.css, app/templates/dashboard.html
- feat(icon & title): 增加站点图标（favicon/svg）并支持在设置中自定义站点标题；模板统一使用 site_title 渲染标题
  - Files: app/icon.svg, app/templates/base.html, app/models.py(AppSetting.site_title), app/database.py(轻量迁移), app/routes/pages.py(传递 site_title), app/templates/dashboard.html(标题配置)
